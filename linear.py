#!/usr/bin/env python3

import argparse
import joblib
import json
import logging

from sklearn.linear_model import SGDClassifier
from sklearn.metrics import roc_auc_score
import settings


LOGGER = logging.getLogger('cve-score')

CLF_DEFAULTS = {
    'loss': 'log',
    'penalty': 'elasticnet',
    'class_weight': 'balanced',
    'alpha': 1e-4,
    'l1_ratio': 0.0,
    'tol': 1e-4,
}

_PARSER = argparse.ArgumentParser()
_PARSER.add_argument('command', help='train|eval')
_PARSER.add_argument('dataset', help='serialized dict of numpy arrays')
_PARSER.add_argument('estimator', help='serialized sklearn estimator')
_PARSER.add_argument('--feature-key', required=True,
    help='feature key in dataset')
_PARSER.add_argument('--label-key', help='label key in dataset')
_PARSER.add_argument('--alpha', type=float, default=1e-4,
    help='classifier L2 penalty term')
_PARSER.add_argument('--l1-ratio', type=float, default=0,
    help='classifier Elastic Net mixing parameter')


def deserialize(filename):
    LOGGER.info('loading %s', filename)
    return joblib.load(filename)


def serialize(filename, object_):
    LOGGER.info('writing %s', filename)
    joblib.dump(object_, filename)


def train(dataset, estimator, feature_key, label_key, **kwargs):
    '''Implements the "train" command.'''
    data = deserialize(dataset)
    features = data[feature_key]
    labels = data[label_key]
    LOGGER.info('features.shape => %s', features.shape)
    params = {
        key: kwargs.get(key, default)
        for (key, default) in CLF_DEFAULTS.items()
    }
    LOGGER.info('estimator params => %s', json.dumps(params))
    clf = SGDClassifier(**params)
    clf.fit(features, labels)
    serialize(estimator, clf)


def eval(dataset, estimator, feature_key, label_key, **kwargs):
    '''Implements the "eval" command.'''
    data = deserialize(dataset)
    features = data[feature_key]
    clf = deserialize(estimator)
    class_probs = clf.predict_proba(features)
    if label_key is not None:
        metrics = dict(AUC=roc_auc_score(data[label_key], class_probs[:,1]))
        LOGGER.info('metrics => %s', json.dumps(metrics))


if __name__ == '__main__':
    args = _PARSER.parse_args()
    settings.configure_logging()

    if args.command == 'train':
        train(**vars(args))
    elif args.command == 'eval':
        eval(**vars(args))
    else:
        print('invalid command: %s' % args.command)
