#!/usr/bin/env python3

import json
import logging
import argparse
import settings
from pymongo import MongoClient

_conn = None

def write(query, filename):
    coll = _conn[query['collection']]
    filter_ = query.get('filter', {})
    project = query.get('projection', {})
    with open(filename, 'w') as fh:
        logging.info('writing to %s', filename)
        for record in coll.find(filter_, project):
            fh.write('%s\n' % json.dumps(record, default=str))


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('query', help='path/to/query.json')
    parser.add_argument('outfile')
    args = parser.parse_args()
    settings.configure_logging()

    query = json.load(open(args.query))
    cfg = settings.MONGO_CONFIG
    logging.info('connecting to %(host)s:%(port)s', cfg)
    client = MongoClient(cfg['host'], cfg['port'])
    _conn = client[cfg['db']]

    write(query, args.outfile)
