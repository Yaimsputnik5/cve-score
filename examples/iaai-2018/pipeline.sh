#!/bin/bash

set -eo pipefail

if [ ! -d "$PWD/examples/iaai-2018" ]; then
    echo "Working directory must be cve-score home."
    exit 0
fi

if [ ! -e "$2" ]; then
    echo "usage: $0 <nvd-records> <attack-sigs>"
    exit 0
fi

NVD_RECORDS=$1
ATTACK_SIGS=$2
CFGDIR="$PWD/examples/iaai-2018"
WORKDIR="/tmp/iaai-2018"
mkdir -p $WORKDIR

echo "Parsing NVD records to $WORKDIR/parsed-features"
cat $NVD_RECORDS |jq -c -f $CFGDIR/parse-nvd.jq >$WORKDIR/parsed-features

echo "Parsing attack signature records to $WORKDIR/parsed-labels"
cat $ATTACK_SIGS |jq -c -f $CFGDIR/parse-attack-sigs.jq >$WORKDIR/parsed-labels

echo "Merging NVD and attack signature records to $WORKDIR/combined"
pipenv run ./curation/merge-json.py \
    $WORKDIR/parsed-features \
    $WORKDIR/parsed-labels \
    $WORKDIR/combined

