#!/bin/bash

set -eo pipefail

if [ ! -d "$PWD/examples/dnn" ]; then
    echo "Working directory must be cve-score home."
    exit 0
fi

if [ ! -e "$2" ]; then
    echo "usage: $0 <nvd-records> <attack-sigs>"
    exit 0
fi

NVD_RECORDS=$1
ATTACK_SIGS=$2
CFGDIR="$PWD/examples/dnn"
WORKDIR="/tmp/dnn"
mkdir -p $WORKDIR

if [ ! -e $WORKDIR/combined ]; then
    echo "Parsing NVD records to $WORKDIR/parsed-features"
    cat $NVD_RECORDS |jq -c -f $CFGDIR/parse-nvd.jq >$WORKDIR/parsed-features

    echo "Parsing attack signature records to $WORKDIR/parsed-labels"
    cat $ATTACK_SIGS |jq -c -f $CFGDIR/parse-attack-sigs.jq >$WORKDIR/parsed-labels

    echo "Merging NVD and attack signature records to $WORKDIR/combined"
    pipenv run ./curation/merge-json.py \
        $WORKDIR/parsed-features \
        $WORKDIR/parsed-labels \
        $WORKDIR/combined
fi

echo "Splitting training examples into $WORKDIR/train-split"
cat $WORKDIR/combined |jq -c 'select(.cveid |test("CVE-201[1-5]"))' \
    >$WORKDIR/train-split
echo "Splitting test examples into $WORKDIR/test-split"
cat $WORKDIR/combined |jq -c 'select(.cveid |test("CVE-201[67]"))' \
    >$WORKDIR/test-split

wc -l $WORKDIR/*-split
echo "Positive examples in $WORKDIR/train-split"
cat $WORKDIR/train-split |jq -c 'select(.attackSignature)' |wc -l

echo "Preprocessing split files..."
pipenv run ./preprocess.py $CFGDIR/data-config.json \
    $WORKDIR/train-{split,preproc} \
    --vocabulary $WORKDIR/vocabulary.json
pipenv run ./preprocess.py $CFGDIR/data-config.json \
    $WORKDIR/test-{split,preproc}

echo "Encoding preprocessed files..."
pipenv run ./encode.py $CFGDIR/data-config.json \
    $WORKDIR/train-{preproc,encoded} \
    --vocabulary $WORKDIR/vocabulary.json
pipenv run ./encode.py $CFGDIR/data-config.json \
    $WORKDIR/test-{preproc,encoded} \
    --vocabulary $WORKDIR/vocabulary.json
