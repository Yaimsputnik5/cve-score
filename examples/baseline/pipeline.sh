#!/bin/bash

if [ ! -d "$PWD/examples/baseline" ]; then
    echo "Working directory must be cve-score home."
    exit 0
fi

if [ ! -e "$1" ]; then
    echo "Must specify path to nvd-records.jsonl file."
    exit 0
fi

CFGDIR="examples/baseline"
WORKDIR="/tmp/baseline"
mkdir -p $WORKDIR

echo "Parsing records to $WORKDIR/parsed"
cat "$1" |jq -c -f $CFGDIR/parse-nvd.jq >$WORKDIR/parsed

echo "Splitting training examples into $WORKDIR/train-split"
cat $WORKDIR/parsed |jq -c 'select(.cveid |test("CVE-201[1-5]"))' \
    >$WORKDIR/train-split
echo "Splitting test examples into $WORKDIR/test-split"
cat $WORKDIR/parsed |jq -c 'select(.cveid |test("CVE-201[67]"))' \
    >$WORKDIR/test-split

wc -l $WORKDIR/*-split

echo "Preprocessing split files..."
pipenv run ./preprocess.py $CFGDIR/config.json \
    $WORKDIR/train-{split,preproc} \
    --vocabulary $WORKDIR/vocabulary.json
pipenv run ./preprocess.py $CFGDIR/config.json \
    $WORKDIR/test-{split,preproc}

echo "Encoding preprocessed files..."
pipenv run ./encode.py $CFGDIR/config.json \
    $WORKDIR/train-{preproc,encoded} \
    --vocabulary $WORKDIR/vocabulary.json
pipenv run ./encode.py $CFGDIR/config.json \
    $WORKDIR/test-{preproc,encoded} \
    --vocabulary $WORKDIR/vocabulary.json
