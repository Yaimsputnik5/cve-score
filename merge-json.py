#!/usr/bin/env python3

import json
import logging
import argparse
import settings

def index(key, filename):
    '''Indexes a file of JSON records its specified `key`.'''
    with open(filename) as fh:
        data = {record[key]: record for record in map(json.loads, fh)}

    logging.info('read %d unique records from %s', len(data), filename)
    return data

def merge(left_index, right_index):
    '''Merges the right records into the left records, returning the set
    of merged records.'''
    for key, record in left_index.items():
        record.update(right_index.get(key, {}))

    return left_index.values()


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('leftkey')
    parser.add_argument('leftfile')
    parser.add_argument('rightkey')
    parser.add_argument('rightfile')
    parser.add_argument('outfile')
    parser.add_argument('--logging', help='JSON file for basicConfig')
    args = parser.parse_args()

    settings.configure_logging(args.logging)

    left_index = index(args.leftkey, args.leftfile)
    right_index = index(args.rightkey, args.rightfile)
    with open(args.outfile, 'w') as fh:
        logging.info('writing %s', args.outfile)
        for record in merge(left_index, right_index):
            fh.write('%s\n' % json.dumps(record))
