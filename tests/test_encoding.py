import json
import unittest
import numpy as np
from scipy import sparse
from encoding import numpy_encoder


class TestNumpyEncoder(unittest.TestCase):

    def test_bow_encoding(self):

        config = [{
            'key': 'test',
            'vocabulary': ['foo', 'bar', 'baz']
        }]
        records = [
            {'test': ['foo', 'baz']},
            {'test': ['bar', 'baz']},
        ]

        def equal_rows(expected, actual):
            return all(expected == actual.toarray()[0])

        actual = numpy_encoder(config, map(json.dumps, records))
        encoded = actual['test']
        self.assertEqual(len(records), len(encoded))
        self.assertIsInstance(encoded[0], sparse.csr_matrix)
        self.assertTrue(equal_rows([1, 0, 1], encoded[0]))
        self.assertTrue(equal_rows([0, 1, 1], encoded[1]))

    def test_weight_encoding(self):

        config = [{
            'key': 'weight',
        }]
        records = [
            {'weight': 0.1},
        ]

        actual = numpy_encoder(config, map(json.dumps, records))
        encoded = actual['weight']
        self.assertEqual(len(records), len(encoded))
        self.assertEqual(encoded[0].dtype, np.float32)
        self.assertAlmostEqual(encoded[0][0], 0.1, 3)

    def test_weight_encoding_default(self):

        config = [{
            'key': 'weight',
        }]
        records = [
            {'missing': True},
        ]

        actual = numpy_encoder(config, map(json.dumps, records))
        encoded = actual['weight']
        self.assertEqual(encoded[0].dtype, np.float32)
        self.assertAlmostEqual(encoded[0][0], 1.0, 3)

    def test_label_encoding(self):

        config = [{
            'key': 'target',
            'isLabel': True,
        }]
        records = [
            {'target': 1},
            {'target': 0},
        ]

        actual = numpy_encoder(config, map(json.dumps, records))
        encoded = actual['target']
        self.assertEqual(len(records), len(encoded))
        self.assertEqual(encoded[0].dtype, np.int64)
        self.assertEqual(encoded[0][0], 1)
        self.assertEqual(encoded[1][0], 0)
