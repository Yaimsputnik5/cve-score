#!/usr/bin/env python3

import os
import sys
import json
import logging
import argparse
import settings
from tf_encoder import TfEncoder

def load_config(filename):
    '''Loads existing config object, returning empty dictionary if missing.'''
    if not os.path.exists(filename):
        return {}
    with open(filename) as fh:
        logging.info('loading existing %s', filename)
        return json.load(fh)

if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('config', help='TF-IDF params (JSON) to build')
    parser.add_argument('--infile', type=argparse.FileType('r'),
        default=sys.stdin, help='[stdin]')
    parser.add_argument('--logging', help='JSON logging config')
    args = parser.parse_args()
    settings.configure_logging(args.logging)

    encoder = TfEncoder(**load_config(args.config))
    encoder.fit(map(json.loads, args.infile))
    with open(args.config, 'w') as fh:
        logging.info('writing %s', args.config)
        json.dump(encoder.params(), fh)
